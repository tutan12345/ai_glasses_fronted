<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase 8.1 æ¨ç†ç¼“å­˜æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            background: #0d1117;
            color: #f0f6fc;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #1f6feb, #238636);
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .test-section {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .test-section h3 {
            color: #58a6ff;
            margin-top: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #8b949e;
        }
        .status-indicator.running { background: #d29922; }
        .status-indicator.success { background: #238636; }
        .status-indicator.error { background: #da3633; }
        button {
            background: #1f6feb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: background 0.2s;
        }
        button:hover { background: #388bfd; }
        button:disabled {
            background: #30363d;
            cursor: not-allowed;
        }
        .results {
            background: #0d1117;
            border: 1px solid #21262d;
            border-radius: 6px;
            padding: 15px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .metric {
            display: inline-block;
            background: #30363d;
            padding: 4px 8px;
            border-radius: 4px;
            margin: 2px;
            font-size: 11px;
        }
        .metric.hit-rate { background: #238636; color: white; }
        .metric.response-time { background: #1f6feb; color: white; }
        .performance-chart {
            display: flex;
            align-items: end;
            height: 150px;
            margin: 20px 0;
            padding: 20px;
            background: #161b22;
            border-radius: 8px;
        }
        .chart-bar {
            flex: 1;
            background: #30363d;
            margin: 0 2px;
            border-radius: 4px 4px 0 0;
            position: relative;
            display: flex;
            align-items: end;
            justify-content: center;
            color: white;
            font-size: 10px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .chart-bar.cached { background: #238636; }
        .chart-bar.uncached { background: #da3633; }
        .chart-label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 9px;
            color: #8b949e;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ Phase 8.1 æ¨ç†ç¼“å­˜æµ‹è¯•</h1>
            <p>æµ‹è¯•ç¼“å­˜é”®ç”Ÿæˆã€å­˜å‚¨æ£€ç´¢å’Œæ€§èƒ½æå‡æ•ˆæœ</p>
        </div>

        <div class="test-section">
            <h3>
                <span class="status-indicator" id="cache-test-status"></span>
                ç¼“å­˜åŸºç¡€åŠŸèƒ½æµ‹è¯•
            </h3>
            <p>æµ‹è¯•ç¼“å­˜é”®ç”Ÿæˆã€å­˜å‚¨å’Œæ£€ç´¢åŠŸèƒ½</p>
            <button onclick="runCacheBasicTest()">è¿è¡ŒåŸºç¡€æµ‹è¯•</button>
            <button onclick="clearCache()">æ¸…ç©ºç¼“å­˜</button>
            <div class="results" id="cache-basic-results">ç­‰å¾…æµ‹è¯•...</div>
        </div>

        <div class="test-section">
            <h3>
                <span class="status-indicator" id="performance-test-status"></span>
                æ€§èƒ½å¯¹æ¯”æµ‹è¯•
            </h3>
            <p>å¯¹æ¯”æœ‰ç¼“å­˜å’Œæ— ç¼“å­˜çš„å“åº”æ—¶é—´</p>
            <button onclick="runPerformanceTest()">è¿è¡Œæ€§èƒ½æµ‹è¯•</button>
            <div class="results" id="performance-results">ç­‰å¾…æµ‹è¯•...</div>
            <div class="performance-chart" id="performance-chart">
                <div class="chart-bar uncached" style="height: 100%">
                    <span>æ— ç¼“å­˜</span>
                    <div class="chart-label">åŸºå‡†</div>
                </div>
                <div class="chart-bar cached" style="height: 20%">
                    <span>æœ‰ç¼“å­˜</span>
                    <div class="chart-label">ä¼˜åŒ–å</div>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h3>
                <span class="status-indicator" id="similarity-test-status"></span>
                ç›¸ä¼¼åº¦åŒ¹é…æµ‹è¯•
            </h3>
            <p>æµ‹è¯•ç›¸ä¼¼æŸ¥è¯¢çš„ç¼“å­˜å‘½ä¸­èƒ½åŠ›</p>
            <button onclick="runSimilarityTest()">è¿è¡Œç›¸ä¼¼åº¦æµ‹è¯•</button>
            <div class="results" id="similarity-results">ç­‰å¾…æµ‹è¯•...</div>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯</h3>
            <button onclick="showCacheStats()">æŸ¥çœ‹ç»Ÿè®¡</button>
            <div class="results" id="cache-stats">ç­‰å¾…ç»Ÿè®¡...</div>
        </div>
    </div>

    <script type="module">
        // å¯¼å…¥ç¼“å­˜ç›¸å…³æ¨¡å—
        import { ReasoningCache } from './lib/core/reasoningCache.js';
        import { CacheKeyGenerator } from './lib/core/cacheKey.js';

        // å…¨å±€å˜é‡
        let cache = null;
        let keyGenerator = null;

        // åˆå§‹åŒ–
        function initCache() {
            if (!cache) {
                cache = new ReasoningCache({
                    maxSize: 50 * 1024 * 1024, // 50MB
                    defaultTtl: 10 * 60 * 1000, // 10åˆ†é’Ÿï¼ˆæµ‹è¯•ç”¨çŸ­æ—¶é—´ï¼‰
                });
                keyGenerator = new CacheKeyGenerator();
                console.log('âœ… ç¼“å­˜ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
            }
        }

        // è®¾ç½®çŠ¶æ€æŒ‡ç¤ºå™¨
        function setStatus(elementId, status) {
            const element = document.getElementById(elementId);
            element.className = 'status-indicator ' + status;
        }

        // åŸºç¡€åŠŸèƒ½æµ‹è¯•
        window.runCacheBasicTest = async function() {
            try {
                setStatus('cache-test-status', 'running');
                initCache();

                const results = document.getElementById('cache-basic-results');
                results.textContent = 'ğŸ”„ å¼€å§‹ç¼“å­˜åŸºç¡€æµ‹è¯•...\n\n';

                // æµ‹è¯•æ•°æ®
                const testIntent = 'æŸ¥è¯¢å¤©æ°”ä¿¡æ¯';
                const testToolCalls = [{
                    name: 'get_weather',
                    args: { city: 'åŒ—äº¬', date: 'ä»Šå¤©' }
                }];
                const testContext = {
                    timestamp: Date.now(),
                    userId: 'test_user',
                    sessionId: 'test_session',
                    location: 'åŒ—äº¬',
                    environment: 'web'
                };

                results.textContent += 'ğŸ“ ç”Ÿæˆç¼“å­˜é”®...\n';
                const cacheKey = keyGenerator.generateKey(testIntent, testToolCalls, testContext);
                results.textContent += `âœ… ç¼“å­˜é”®ID: ${cacheKey.id}\n`;
                results.textContent += `âœ… æ„å›¾: ${cacheKey.intent}\n`;
                results.textContent += `âœ… å·¥å…·ç­¾å: ${cacheKey.toolSignature}\n\n`;

                // å­˜å‚¨æµ‹è¯•
                results.textContent += 'ğŸ’¾ å­˜å‚¨æµ‹è¯•ç»“æœ...\n';
                const mockResult = {
                    success: true,
                    data: { temperature: 25, weather: 'æ™´å¤©', humidity: 60 },
                    timestamp: Date.now()
                };

                await cache.store(testIntent, testToolCalls, testContext, mockResult);
                results.textContent += 'âœ… å­˜å‚¨æˆåŠŸ\n\n';

                // æ£€ç´¢æµ‹è¯•
                results.textContent += 'ğŸ” æ£€ç´¢æµ‹è¯•...\n';
                const retrieved = await cache.retrieve(testIntent, testToolCalls, testContext);

                if (retrieved) {
                    results.textContent += 'âœ… æ£€ç´¢æˆåŠŸ (ç¼“å­˜å‘½ä¸­)\n';
                    results.textContent += `ğŸ“Š ç»“æœ: ${JSON.stringify(retrieved.data, null, 2)}\n`;
                    results.textContent += `âš¡ å“åº”æ—¶é—´: ${Date.now() - retrieved.metadata.cachedAt}ms\n`;
                    results.textContent += `ğŸ¯ ç½®ä¿¡åº¦: ${(retrieved.metadata.confidence * 100).toFixed(1)}%\n`;
                } else {
                    results.textContent += 'âŒ æ£€ç´¢å¤±è´¥\n';
                }

                results.textContent += '\nğŸ‰ åŸºç¡€æµ‹è¯•å®Œæˆï¼';
                setStatus('cache-test-status', 'success');

            } catch (error) {
                console.error('åŸºç¡€æµ‹è¯•å¤±è´¥:', error);
                document.getElementById('cache-basic-results').textContent += `\nâŒ æµ‹è¯•å¤±è´¥: ${error.message}`;
                setStatus('cache-test-status', 'error');
            }
        };

        // æ€§èƒ½æµ‹è¯•
        window.runPerformanceTest = async function() {
            try {
                setStatus('performance-test-status', 'running');
                initCache();

                const results = document.getElementById('performance-results');
                results.textContent = 'ğŸ”„ å¼€å§‹æ€§èƒ½å¯¹æ¯”æµ‹è¯•...\n\n';

                // æµ‹è¯•æ•°æ®
                const testIntent = 'æ•°å­¦è®¡ç®—';
                const testToolCalls = [{ name: 'calculator', args: { expression: '123 * 456' } }];
                const testContext = {
                    timestamp: Date.now(),
                    userId: 'perf_test',
                    sessionId: 'perf_session'
                };

                // æ¨¡æ‹Ÿå·¥å…·æ‰§è¡Œç»“æœ
                const mockResult = {
                    result: 123 * 456,
                    expression: '123 * 456',
                    timestamp: Date.now()
                };

                // é¦–æ¬¡æ‰§è¡Œï¼ˆæ— ç¼“å­˜ï¼‰
                results.textContent += 'ğŸš€ é¦–æ¬¡æ‰§è¡Œ (æ— ç¼“å­˜)...\n';
                const startTime1 = performance.now();

                // æ¨¡æ‹Ÿæ¨ç†å»¶è¿Ÿ
                await new Promise(resolve => setTimeout(resolve, 50));

                const endTime1 = performance.now();
                const time1 = endTime1 - startTime1;

                results.textContent += `â±ï¸ è€—æ—¶: ${time1.toFixed(2)}ms\n\n`;

                // å­˜å‚¨åˆ°ç¼“å­˜
                await cache.store(testIntent, testToolCalls, testContext, mockResult);
                results.textContent += 'ğŸ’¾ ç»“æœå·²ç¼“å­˜\n\n';

                // ç¬¬äºŒæ¬¡æ‰§è¡Œï¼ˆæœ‰ç¼“å­˜ï¼‰
                results.textContent += 'âš¡ ç¬¬äºŒæ¬¡æ‰§è¡Œ (æœ‰ç¼“å­˜)...\n';
                const startTime2 = performance.now();

                const cachedResult = await cache.retrieve(testIntent, testToolCalls, testContext);

                const endTime2 = performance.now();
                const time2 = endTime2 - startTime2;

                if (cachedResult) {
                    results.textContent += `âœ… ç¼“å­˜å‘½ä¸­!\n`;
                    results.textContent += `â±ï¸ è€—æ—¶: ${time2.toFixed(2)}ms\n`;
                    results.textContent += `ğŸ“Š ç»“æœ: ${cachedResult.data.result}\n`;

                    const speedup = ((time1 - time2) / time1 * 100).toFixed(1);
                    results.textContent += `ğŸš€ æé€Ÿ: ${speedup}%\n`;

                    // æ›´æ–°å›¾è¡¨
                    updatePerformanceChart(time1, time2);
                }

                results.textContent += '\nğŸ‰ æ€§èƒ½æµ‹è¯•å®Œæˆï¼';
                setStatus('performance-test-status', 'success');

            } catch (error) {
                console.error('æ€§èƒ½æµ‹è¯•å¤±è´¥:', error);
                document.getElementById('performance-results').textContent += `\nâŒ æµ‹è¯•å¤±è´¥: ${error.message}`;
                setStatus('performance-test-status', 'error');
            }
        };

        // æ›´æ–°æ€§èƒ½å›¾è¡¨
        function updatePerformanceChart(time1, time2) {
            const chart = document.getElementById('performance-chart');
            const bars = chart.querySelectorAll('.chart-bar');

            // åŸºå‡†é«˜åº¦
            const maxHeight = 120;
            const height1 = Math.min(maxHeight, (time1 / 10)); // æ¯10mså¯¹åº”1px
            const height2 = Math.min(maxHeight, (time2 / 10));

            bars[0].style.height = height1 + 'px';
            bars[0].querySelector('span').textContent = time1.toFixed(0) + 'ms';

            bars[1].style.height = height2 + 'px';
            bars[1].querySelector('span').textContent = time2.toFixed(0) + 'ms';
        }

        // ç›¸ä¼¼åº¦æµ‹è¯•
        window.runSimilarityTest = async function() {
            try {
                setStatus('similarity-test-status', 'running');
                initCache();

                const results = document.getElementById('similarity-results');
                results.textContent = 'ğŸ”„ å¼€å§‹ç›¸ä¼¼åº¦åŒ¹é…æµ‹è¯•...\n\n';

                // å­˜å‚¨å‡ ä¸ªä¸åŒçš„æŸ¥è¯¢
                const queries = [
                    { intent: 'æŸ¥è¯¢åŒ—äº¬å¤©æ°”', tool: 'get_weather', city: 'åŒ—äº¬' },
                    { intent: 'æŸ¥çœ‹ä¸Šæµ·å¤©æ°”æƒ…å†µ', tool: 'get_weather', city: 'ä¸Šæµ·' },
                    { intent: 'å¹¿å·å¤©æ°”æ€ä¹ˆæ ·', tool: 'get_weather', city: 'å¹¿å·' },
                    { intent: 'è®¡ç®—æ•°å­¦é¢˜', tool: 'calculator', expr: '2+3' },
                ];

                results.textContent += 'ğŸ“ å­˜å‚¨æµ‹è¯•æ•°æ®...\n';
                for (const query of queries) {
                    const toolCalls = query.tool === 'get_weather' ?
                        [{ name: 'get_weather', args: { city: query.city } }] :
                        [{ name: 'calculator', args: { expression: query.expr } }];

                    const context = {
                        timestamp: Date.now(),
                        userId: 'similarity_test',
                        sessionId: 'similarity_session'
                    };

                    const result = query.tool === 'get_weather' ?
                        { weather: 'æ™´å¤©', temp: 25 } :
                        { result: eval(query.expr) };

                    await cache.store(query.intent, toolCalls, context, result);
                }
                results.textContent += 'âœ… æµ‹è¯•æ•°æ®å­˜å‚¨å®Œæˆ\n\n';

                // æµ‹è¯•ç›¸ä¼¼æŸ¥è¯¢
                results.textContent += 'ğŸ” æµ‹è¯•ç›¸ä¼¼æŸ¥è¯¢...\n';
                const similarResults = await cache.findSimilar('å¤©æ°”', 5);

                results.textContent += `ğŸ“Š æ‰¾åˆ° ${similarResults.length} ä¸ªç›¸ä¼¼ç»“æœ:\n`;
                similarResults.forEach((result, index) => {
                    results.textContent += `${index + 1}. ${result.cacheKey.intent}\n`;
                    results.textContent += `   å·¥å…·: ${result.cacheKey.toolSignature}\n`;
                    results.textContent += `   ç»“æœ: ${JSON.stringify(result.result)}\n\n`;
                });

                // æµ‹è¯•ç²¾ç¡®åŒ¹é…
                const exactQuery = {
                    intent: 'æŸ¥è¯¢åŒ—äº¬å¤©æ°”',
                    toolCalls: [{ name: 'get_weather', args: { city: 'åŒ—äº¬' } }],
                    context: {
                        timestamp: Date.now(),
                        userId: 'similarity_test',
                        sessionId: 'similarity_session'
                    }
                };

                const exactResult = await cache.retrieve(exactQuery.intent, exactQuery.toolCalls, exactQuery.context);
                if (exactResult) {
                    results.textContent += 'ğŸ¯ ç²¾ç¡®åŒ¹é…æµ‹è¯•: æˆåŠŸ\n';
                    results.textContent += `   ç»“æœ: ${JSON.stringify(exactResult.data)}\n`;
                }

                results.textContent += '\nğŸ‰ ç›¸ä¼¼åº¦æµ‹è¯•å®Œæˆï¼';
                setStatus('similarity-test-status', 'success');

            } catch (error) {
                console.error('ç›¸ä¼¼åº¦æµ‹è¯•å¤±è´¥:', error);
                document.getElementById('similarity-results').textContent += `\nâŒ æµ‹è¯•å¤±è´¥: ${error.message}`;
                setStatus('similarity-test-status', 'error');
            }
        };

        // æ˜¾ç¤ºç¼“å­˜ç»Ÿè®¡
        window.showCacheStats = async function() {
            try {
                if (!cache) initCache();

                const stats = await cache.getStats();
                const statsDiv = document.getElementById('cache-stats');

                statsDiv.innerHTML = `
ğŸ“Š ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
æ€»æ¡ç›®æ•°: ${stats.totalEntries}
æ€»å¤§å°: ${(stats.totalSize / 1024).toFixed(2)} KB
å‘½ä¸­ç‡: ${stats.hitRate ? (stats.hitRate * 100).toFixed(1) : 'N/A'}%
å¹³å‡å“åº”æ—¶é—´: ${stats.averageAccessTime ? stats.averageAccessTime.toFixed(2) : 'N/A'}ms
æœ€æ—©æ¡ç›®: ${new Date(stats.oldestEntry).toLocaleString()}
æœ€æ–°æ¡ç›®: ${new Date(stats.newestEntry).toLocaleString()}
è¿è¡Œæ—¶é—´: ${Math.floor(stats.uptime / 1000 / 60)} åˆ† ${Math.floor((stats.uptime / 1000) % 60)} ç§’

ğŸ“‹ é…ç½®ä¿¡æ¯
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
æœ€å¤§ç¼“å­˜å¤§å°: ${(stats.config.maxSize / 1024 / 1024).toFixed(1)} MB
é»˜è®¤TTL: ${stats.config.defaultTtl / 1000 / 60} åˆ†é’Ÿ
æ¸…ç†é—´éš”: ${stats.config.cleanupInterval / 1000 / 60} åˆ†é’Ÿ
å¯ç”¨å‹ç¼©: ${stats.config.enableCompression ? 'æ˜¯' : 'å¦'}
                `;

            } catch (error) {
                console.error('è·å–ç»Ÿè®¡å¤±è´¥:', error);
                document.getElementById('cache-stats').textContent = `âŒ è·å–ç»Ÿè®¡å¤±è´¥: ${error.message}`;
            }
        };

        // æ¸…ç©ºç¼“å­˜
        window.clearCache = async function() {
            try {
                if (!cache) initCache();

                await cache.clear();
                document.getElementById('cache-basic-results').textContent = 'ğŸ—‘ï¸ ç¼“å­˜å·²æ¸…ç©º';
                document.getElementById('cache-stats').textContent = 'ç­‰å¾…ç»Ÿè®¡...';

                // é‡ç½®å›¾è¡¨
                const bars = document.querySelectorAll('.chart-bar');
                bars[0].style.height = '100px';
                bars[0].querySelector('span').textContent = 'æ— ç¼“å­˜';
                bars[1].style.height = '20px';
                bars[1].querySelector('span').textContent = 'æœ‰ç¼“å­˜';

                console.log('ç¼“å­˜å·²æ¸…ç©º');

            } catch (error) {
                console.error('æ¸…ç©ºç¼“å­˜å¤±è´¥:', error);
                alert(`æ¸…ç©ºç¼“å­˜å¤±è´¥: ${error.message}`);
            }
        };

        // é¡µé¢åŠ è½½å®Œæˆåˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Phase 8.1 ç¼“å­˜æµ‹è¯•é¡µé¢å·²åŠ è½½');
        });
    </script>
</body>
</html>
